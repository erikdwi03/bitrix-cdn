# ๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต Bitrix CDN Server

## โ๏ธ ะะะะขะะงะะกะะ ะะะะะ: ะััะธัะตะบัััะฐ ะธะท 2-ั ัะตัะฒะตัะพะฒ!

ะญัะพ ัะตัะตะฝะธะต ััะตะฑัะตั **ะะะ ะคะะะะงะะกะะ ะะะะะซะฅ ะกะะะะะะ**:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะกะะะะะ 1 (ะะะขะะะะก)     โ <-----> โ  ะกะะะะะ 2 (CDN)         โ
โ  โข ะะฐั ัะตะบััะธะน ัะฐะนั     โ   SSH   โ  โข ะญัะพั ะฟัะพะตะบั          โ
โ  โข ะฅัะฐะฝะธั ะพัะธะณะธะฝะฐะปั     โ         โ  โข ะขะพะปัะบะพ WebP ะบะตั      โ
โ  โข IP: 192.168.1.10     โ         โ  โข IP: 192.168.1.20     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะัะตะดะฒะฐัะธัะตะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

### ะกะตัะฒะตั 1 (ะะธััะธะบั) - ัะถะต ัััะตััะฒัััะธะน:
- โ ะะฐะฑะพัะฐััะธะน ัะฐะนั ะฝะฐ 1ะก-ะะธััะธะบั
- โ SSH ะดะพัััะฟ ั ะฟัะฐะฒะฐะผะธ ะฝะฐ ััะตะฝะธะต `/var/www/bitrix/upload/`
- โ ะัะบััั ะฟะพัั 22 ะดะปั ะกะตัะฒะตัะฐ 2

### ะกะตัะฒะตั 2 (CDN) - ะฝะพะฒัะน ัะตัะฒะตั:
- โ Debian 11/12 ะธะปะธ Ubuntu 20.04/22.04
- โ ะะธะฝะธะผัะผ 2 CPU, 4GB RAM, 50GB SSD
- โ Docker ะธ Docker Compose ัััะฐะฝะพะฒะปะตะฝั
- โ ะะพะผะตะฝ cdn.termokit.ru ะฝะฐะฟัะฐะฒะปะตะฝ ะฝะฐ ััะพั ัะตัะฒะตั
- โ ะะพััั 80, 443 ะพัะบัััั

## ๐ง ะะพัะฐะณะพะฒะฐั ะธะฝััััะบัะธั ัะฐะทะฒะตัััะฒะฐะฝะธั

### ะจะะ 1: ะะพะดะณะพัะพะฒะบะฐ ะกะตัะฒะตัะฐ 2 (CDN)

```bash
# 1.1 ะฃััะฐะฝะพะฒะบะฐ Docker (ะตัะปะธ ะตัะต ะฝะตั)
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
# ะะตัะตะปะพะณะธะฝััะตัั ะดะปั ะฟัะธะผะตะฝะตะฝะธั ะฟัะฐะฒ

# 1.2 ะฃััะฐะฝะพะฒะบะฐ Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 1.3 ะะปะพะฝะธัะพะฒะฐะฝะธะต ะฟัะพะตะบัะฐ
git clone https://github.com/AAChibilyaev/bitrix-cdn.git
cd bitrix-cdn
```

### ะจะะ 2: ะะฐัััะพะนะบะฐ SSH ัะพะตะดะธะฝะตะฝะธั ะผะตะถะดั ัะตัะฒะตัะฐะผะธ

```bash
# 2.1 ะะฐ ะกะตัะฒะตัะต 2 (CDN) - ะณะตะฝะตัะฐัะธั SSH ะบะปััะฐ
./docker-manage.sh setup
# ะะปะธ ะฒัััะฝัั:
ssh-keygen -t rsa -b 4096 -f docker/ssh/bitrix_mount -N ""

# 2.2 ะกะบะพะฟะธััะนัะต ะฟัะฑะปะธัะฝัะน ะบะปัั
cat docker/ssh/bitrix_mount.pub
```

```bash
# 2.3 ะะฐ ะกะตัะฒะตัะต 1 (ะะธััะธะบั) - ะดะพะฑะฐะฒััะต ะบะปัั
sudo su - www-data  # ะธะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะด ะบะพัะพััะผ ัะฐะฑะพัะฐะตั ัะฐะนั
mkdir -p ~/.ssh
echo "ะะกะขะะะฌะขะ_ะกะฎะะ_ะะฃะะะะงะะซะ_ะะะฎะง" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 2.4 ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ั ะกะตัะฒะตัะฐ 2
ssh -i docker/ssh/bitrix_mount www-data@192.168.1.10 "ls /var/www/bitrix/upload/"
# ะะพะปะถะฝั ัะฒะธะดะตัั ัะฟะธัะพะบ ัะฐะนะปะพะฒ
```

### ะจะะ 3: ะะพะฝัะธะณััะฐัะธั ะพะบััะถะตะฝะธั

```bash
# 3.1 ะะฐ ะกะตัะฒะตัะต 2 (CDN) - ัะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ
cp .env.example .env
nano .env
```

ะััะตะดะฐะบัะธััะนัะต ะฟะฐัะฐะผะตััั:
```env
# ะะพะดะบะปััะตะฝะธะต ะบ ะกะตัะฒะตัั 1 (ะะธััะธะบั)
BITRIX_SERVER_IP=192.168.1.10          # IP ะฒะฐัะตะณะพ ะะธััะธะบั ัะตัะฒะตัะฐ
BITRIX_SERVER_USER=www-data            # ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐ ะะธััะธะบั ัะตัะฒะตัะต
BITRIX_UPLOAD_PATH=/var/www/bitrix/upload  # ะััั ะบ upload ะฝะฐ ะะธััะธะบั

# ะะฐัััะพะนะบะธ CDN
CDN_DOMAIN=cdn.termokit.ru             # ะะฐั CDN ะดะพะผะตะฝ
CDN_SERVER_IP=192.168.1.20             # IP ััะพะณะพ CDN ัะตัะฒะตัะฐ

# WebP ะฝะฐัััะพะนะบะธ
WEBP_QUALITY=85                         # ะะฐัะตััะฒะพ WebP (1-100)
CACHE_CLEANUP_DAYS=30                   # ะะฒัะพะพัะธััะบะฐ ะบะตัะฐ ััะฐััะต N ะดะฝะตะน

# ะะพะฝะธัะพัะธะฝะณ
ADMIN_EMAIL=admin@termokit.ru
GRAFANA_PASSWORD=SecurePassword123!
REDIS_PASSWORD=RedisPassword456!

# SSL (ะดะปั Let's Encrypt)
LETSENCRYPT_EMAIL=admin@termokit.ru
```

### ะจะะ 4: ะะฐะฟััะบ CDN ัะตัะฒะตัะฐ

```bash
# 4.1 ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะน
./validate-all.sh
# ะัะต ะฟัะพะฒะตัะบะธ ะดะพะปะถะฝั ะฟัะพะนัะธ ััะฟะตัะฝะพ

# 4.2 ะะฐะฟััะบ ัะตัะฒะธัะพะฒ
docker-compose up -d

# 4.3 ะัะพะฒะตัะบะฐ ััะฐัััะฐ
./docker-manage.sh status

# 4.4 ะัะพัะผะพัั ะปะพะณะพะฒ
docker-compose logs -f
```

### ะจะะ 5: ะะฐัััะพะนะบะฐ SSL ัะตััะธัะธะบะฐัะฐ

```bash
# 5.1 ะะตัะฒะพะฝะฐัะฐะปัะฝัะน ะทะฐะฟััะบ ะดะปั ะฟะพะปััะตะฝะธั ัะตััะธัะธะบะฐัะฐ
docker-compose run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email admin@termokit.ru \
  --agree-tos \
  --no-eff-email \
  -d cdn.termokit.ru

# 5.2 ะะฐัะบะพะผะผะตะฝัะธััะนัะต SSL ะฝะฐัััะพะนะบะธ ะฒ docker/nginx/conf.d/cdn.conf
nano docker/nginx/conf.d/cdn.conf
# ะะฐัะบะพะผะผะตะฝัะธััะนัะต ัััะพะบะธ ั ssl_certificate

# 5.3 ะะตัะตะทะฐะฟััะบ NGINX
docker-compose restart nginx
```

### ะจะะ 6: ะะฝัะตะณัะฐัะธั ั ะะธััะธะบั (ะฝะฐ ะกะตัะฒะตัะต 1)

```php
// 6.1 ะะพะฑะฐะฒััะต ะฒ /bitrix/php_interface/init.php
define("BX_IMG_SERVER", "https://cdn.termokit.ru");

// 6.2 ะะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะทะฐะผะตะฝั URL ะธะทะพะฑัะฐะถะตะฝะธะน
AddEventHandler("main", "OnEndBufferContent", "ReplaceCDNImages");
function ReplaceCDNImages(&$content) {
    $content = str_replace(
        'src="/upload/',
        'src="https://cdn.termokit.ru/upload/',
        $content
    );
    $content = preg_replace(
        '/url\(["\']?\/upload\//i',
        'url("https://cdn.termokit.ru/upload/',
        $content
    );
}
```

### ะจะะ 7: ะัะพะฒะตัะบะฐ ัะฐะฑะพัั

```bash
# 7.1 ะัะพะฒะตัะบะฐ SSHFS ะผะพะฝัะธัะพะฒะฐะฝะธั (ะฝะฐ ะกะตัะฒะตัะต 2)
docker exec cdn-sshfs ls -la /mnt/bitrix/upload/
# ะะพะปะถะฝั ัะฒะธะดะตัั ัะฐะนะปั ั ะะธััะธะบั ัะตัะฒะตัะฐ

# 7.2 ะัะพะฒะตัะบะฐ ะบะพะฝะฒะตััะฐัะธะธ WebP
curl -H "Accept: image/webp" https://cdn.termokit.ru/upload/iblock/123/test.jpg
# ะ ะปะพะณะฐั ะดะพะปะถะฝะฐ ะฟะพัะฒะธัััั ะบะพะฝะฒะตััะฐัะธั

# 7.3 ะัะพะฒะตัะบะฐ ะบะตัะฐ
ls -la /var/lib/docker/volumes/bitrix-cdn_webp-cache/_data/
# ะะพะปะถะฝั ะฟะพัะฒะธัััั .webp ัะฐะนะปั

# 7.4 ะะพะฝะธัะพัะธะฝะณ
# ะัะบัะพะนัะต ะฒ ะฑัะฐัะทะตัะต:
# Grafana: http://cdn.termokit.ru:3000 (admin/admin)
# Prometheus: http://cdn.termokit.ru:9090
```

## ๐ ะะฐะปะธะดะฐัะธั ัะฐะทะฒะตัััะฒะฐะฝะธั

ะัะฟะพะปะฝะธัะต ะฟะพะปะฝัั ะฟัะพะฒะตัะบั:
```bash
./validate-all.sh
```

ะะพะปะถะฝั ัะฒะธะดะตัั:
```
โ ะะกะ ะะะะะะะะ ะะะะะะะะซ ะฃะกะะะจะะ!
ะัะพะตะบั ะณะพัะพะฒ ะบ ัะฐะทะฒะตัััะฒะฐะฝะธั ะฝะฐ cdn.termokit.ru
```

## โ๏ธ ะงะฐัััะต ะฟัะพะฑะปะตะผั ะฟัะธ ัะฐะทะฒะตัััะฒะฐะฝะธะธ

### ะัะพะฑะปะตะผะฐ: SSHFS ะฝะต ะผะพะถะตั ะฟะพะดะบะปััะธัััั
```bash
# ะัะพะฒะตัััะต SSH ะฟะพะดะบะปััะตะฝะธะต
ssh -i docker/ssh/bitrix_mount www-data@BITRIX_IP "echo OK"

# ะัะพะฒะตัััะต ะฟัะฐะฒะฐ ะฝะฐ ะบะปัั
chmod 600 docker/ssh/bitrix_mount

# ะัะพะฒะตัััะต ะปะพะณะธ SSHFS
docker logs cdn-sshfs
```

### ะัะพะฑะปะตะผะฐ: WebP ัะฐะนะปั ะฝะต ัะพะทะดะฐัััั
```bash
# ะัะพะฒะตัััะต ะฟัะฐะฒะฐ ะฝะฐ ะดะธัะตะบัะพัะธั ะบะตัะฐ
docker exec cdn-webp-converter ls -la /var/cache/webp/

# ะัะพะฒะตัััะต ะปะพะณะธ ะบะพะฝะฒะตััะตัะฐ
docker logs cdn-webp-converter

# ะัะพะฒะตัััะต ััะพ NGINX ะฟัะฐะฒะธะปัะฝะพ ะฟัะพะบัะธััะตั
docker logs cdn-nginx
```

### ะัะพะฑะปะตะผะฐ: 502 Bad Gateway
```bash
# ะัะพะฒะตัััะต ััะพ ะฒัะต ัะตัะฒะธัั ะทะฐะฟััะตะฝั
docker-compose ps

# ะะตัะตะทะฐะฟัััะธัะต ัะตัะฒะธัั
docker-compose restart

# ะัะพะฒะตัััะต ัะตัั Docker
docker network ls
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะฟะพัะปะต ัะฐะทะฒะตัััะฒะฐะฝะธั

### ะะปััะตะฒัะต ะผะตััะธะบะธ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั:
1. **Cache Hit Rate** - ะดะพะปะถะตะฝ ะฑััั >80% ะฟะพัะปะต ะฟัะพะณัะตะฒะฐ
2. **WebP Conversion Rate** - ะบะพะปะธัะตััะฒะพ ะบะพะฝะฒะตััะฐัะธะน/ัะตะบ
3. **SSHFS Mount Status** - ะดะพะปะถะตะฝ ะฑััั ะฒัะตะณะดะฐ "mounted"
4. **Disk Usage** - ัะปะตะดะธัะต ะทะฐ ัะฐะทะผะตัะพะผ ะบะตัะฐ WebP

### ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ะบะตัะฐ:
```bash
# ะะพะฑะฐะฒััะต ะฒ crontab ะฝะฐ ะกะตัะฒะตัะต 2
0 3 * * * /path/to/bitrix-cdn/docker-manage.sh clean
```

## ๐ฏ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ

ะะพัะปะต ัะฐะทะฒะตัััะฒะฐะฝะธั ัะฑะตะดะธัะตัั:
1. โ ะะทะพะฑัะฐะถะตะฝะธั ะทะฐะณััะถะฐัััั ั cdn.termokit.ru
2. โ WebP ะฒะตััะธะธ ะพัะดะฐัััั ะดะปั ะฟะพะดะดะตัะถะธะฒะฐััะธั ะฑัะฐัะทะตัะพะฒ
3. โ ะัะธะณะธะฝะฐะปั ะพััะฐัััั ะฝะฐ ะะธััะธะบั ัะตัะฒะตัะต
4. โ ะัะธ ะทะฐะณััะทะบะต ะฝะพะฒัั ัะฐะนะปะพะฒ ะฝะฐ ะะธััะธะบั ะพะฝะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะพัััะฟะฝั ัะตัะตะท CDN
5. โ ะะพะฝะธัะพัะธะฝะณ ัะฐะฑะพัะฐะตั ะธ ะฟะพะบะฐะทัะฒะฐะตั ะผะตััะธะบะธ

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะธ ะฟัะพะฑะปะตะผะฐั:
1. ะัะพะฒะตัััะต ะปะพะณะธ: `docker-compose logs -f`
2. ะะฐะฟัััะธัะต ะฒะฐะปะธะดะฐัะธั: `./validate-all.sh`
3. ะัะพะฒะตัััะต ะดะพะบัะผะตะฝัะฐัะธั ะฒ `/docs/TROUBLESHOOTING.md`

---
**ะะฐะถะฝะพ**: ะญัะพั CDN ัะตัะฒะตั ะะ ััะฐะฝะธั ะพัะธะณะธะฝะฐะปั ัะฐะนะปะพะฒ! ะะฝ ัะพะปัะบะพ ัะธัะฐะตั ะธั ั ะะธััะธะบั ัะตัะฒะตัะฐ ัะตัะตะท SSHFS ะธ ัะพะทะดะฐะตั ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะฝัะต WebP ะฒะตััะธะธ ะฒ ัะฒะพะตะผ ะปะพะบะฐะปัะฝะพะผ ะบะตัะต.